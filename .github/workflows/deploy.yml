name: ğŸš€ Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¤ Notify Discord - Start Deploy
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"âš™ï¸ à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ Deploy à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸ GitHub... \nğŸ“¦ Repo: $GITHUB_REPOSITORY\nğŸ” Commit: $GITHUB_SHA\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ§ Connect to EC2 and deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "âœ… Connected to EC2"
            cd Chatbot-101
            echo "ğŸ“¦ Pulling latest code..."
            git pull origin main || {
              echo "âŒ Git pull failed"
              exit 1
            }

            echo "ğŸ§¹ Stopping and cleaning up old containers..."
            docker-compose down --volumes --remove-orphans

            echo "ğŸš€ Building and starting new containers..."
            docker-compose up --build -d

            echo "ğŸ§½ Cleaning up unused containers, volumes, networks, and images..."
            docker system prune -a --volumes -f

            echo "âœ… Deployment and cleanup complete!"
            docker ps

      - name: âœ… Notify Discord - Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"âœ… Deployment à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§à¸šà¸™ EC2 ğŸ‰ \nğŸ“¦ Repo: $GITHUB_REPOSITORY\nğŸ” Commit: $GITHUB_SHA\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: âŒ Notify Discord - Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"âŒ Deployment à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§! \nğŸ“¦ Repo: $GITHUB_REPOSITORY\nğŸ•µï¸ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸—à¸µà¹ˆ GitHub Actions logs\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
